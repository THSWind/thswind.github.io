{"title":"GPU manual for the poor","date":"2019-10-08T05:06:02.000Z","date_formatted":{"ll":"Oct 8, 2019","L":"10/08/2019","MM-DD":"10-08"},"link":"undefined/GPU manual for the poor","comments":true,"tags":["server"],"updated":"2019-10-08T05:06:02.000Z","content":"<p>在资源紧张的情况下，除了要计划经济以外，我们还要计划gpu的使用。在此背景下，总结一份 gpu勤俭指南。</p>\n<h1 id=\"注意\">注意<a title=\"#注意\" href=\"#注意\"></a></h1>\n<p>运行程序前使用 CUDA_VISIBLE_DEVICES=GPU编号 来指定使用哪块显卡，用多显卡的话在程序里写好，如果直接用 python **.py, 这样会占用全部显卡。</p>\n<h1 id=\"监控gpu状态\">监控GPU状态<a title=\"#监控gpu状态\" href=\"#监控gpu状态\"></a></h1>\n<p>首先需要安装 gpustat 功能：</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip  install gpustat</span><br></pre></td></tr></table></figure>\n<p>查看gpu状态：</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gpustat -u</span><br></pre></td></tr></table></figure>\n<h1 id=\"指定使用gpu\">指定使用GPU<a title=\"#指定使用gpu\" href=\"#指定使用gpu\"></a></h1>\n<h2 id=\"pytorch下：\">pytorch下：<a title=\"#pytorch下：\" href=\"#pytorch下：\"></a></h2>\n<ol>\n<li>\n<p>直接在终端指定：</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CUDA_VISIBLE_DEVICES=<span class=\"number\">1</span> python my_script.py</span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p>pyton代码中指定：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\">os.environ[<span class=\"string\">&quot;CUDA_VISIBLE_DEVICES&quot;</span>] = <span class=\"string\">&quot;2&quot;</span></span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>以上两种方式类似于tensorflow指定gpu的方式</p>\n<ol start=\"3\">\n<li>\n<p>使用set_device函数指定：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> torch</span><br><span class=\"line\">torch.cuda.set_device(<span class=\"built_in\">id</span>)</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>ps: gpu编号从0开始</p>\n<h2 id=\"tensorflow下：\">tensorflow下：<a title=\"#tensorflow下：\" href=\"#tensorflow下：\"></a></h2>\n<ol>\n<li>可在文件开头加入以下代码</li>\n</ol>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\">os.environ[<span class=\"string\">&quot;CUDA_DEVICE_ORDER&quot;</span>] = <span class=\"string\">&quot;PCI_BUS_ID&quot;</span></span><br><span class=\"line\">os.environ[<span class=\"string\">&quot;CUDA_VISIBLE_DEVICES&quot;</span>] = <span class=\"string\">&quot;1&quot;</span>       <span class=\"comment\"># 使用第二块GPU（从0开始）</span></span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>\n<p>也可以指定使用某几块gpu</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\">os.environ[<span class=\"string\">&quot;CUDA_DEVICE_ORDER&quot;</span>] = <span class=\"string\">&quot;PCI_BUS_ID&quot;</span></span><br><span class=\"line\">os.environ[<span class=\"string\">&quot;CUDA_VISIBLE_DEVICES&quot;</span>] = <span class=\"string\">&quot;0, 2&quot;</span>    <span class=\"comment\"># 使用第一, 三块GPU</span></span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p>禁用GPU</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\">os.environ[<span class=\"string\">&quot;CUDA_VISIBLE_DEVICES&quot;</span>] = <span class=\"string\">&quot;-1&quot;</span></span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h1 id=\"强制仅使用cpu\">强制仅使用CPU<a title=\"#强制仅使用cpu\" href=\"#强制仅使用cpu\"></a></h1>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\">os.environ[<span class=\"string\">&quot;CUDA_DEVICE_ORDER&quot;</span>] = <span class=\"string\">&quot;PCI_BUS_ID&quot;</span>   <span class=\"comment\"># see issue #152</span></span><br><span class=\"line\">os.environ[<span class=\"string\">&quot;CUDA_VISIBLE_DEVICES&quot;</span>] = <span class=\"string\">&quot; &quot;</span></span><br></pre></td></tr></table></figure>\n","prev":{"title":"Attach printer","link":"undefined/Attach printer"},"next":{"title":"linux+python+virtual environment","link":"undefined/Linux+python+virtual environment"},"plink":"http://thswind.github.io/undefined/GPU manual for the poor/","toc":[{"id":"注意","title":"注意","index":"1"},{"id":"监控gpu状态","title":"监控GPU状态","index":"2"},{"id":"指定使用gpu","title":"指定使用GPU","index":"3","children":[{"id":"pytorch下：","title":"pytorch下：","index":"3.1"},{"id":"tensorflow下：","title":"tensorflow下：","index":"3.2"}]},{"id":"强制仅使用cpu","title":"强制仅使用CPU","index":"4"}],"reading_time":"298 words in 2 min"}